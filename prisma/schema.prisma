// Prisma schema for AI Lab MVP
// SQLite for MVP - easily migratable to PostgreSQL later

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Single user auth for local MVP
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  apiKeys ApiKey[]
  tests   Test[]
  runs    Run[]

  @@map("users")
}

// API Keys - encrypted at rest
model ApiKey {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  name          String   // User-friendly name
  provider      String   // openai, anthropic, google, deepseek, local
  encryptedKey  String   @map("encrypted_key") // AES-256-GCM encrypted
  iv            String   // Initialization vector (hex)
  authTag       String   @map("auth_tag") // GCM auth tag (hex)
  keyLastFour   String   @map("key_last_four") // Last 4 chars for display
  baseUrl       String?  @map("base_url") // For local/custom endpoints
  isActive      Boolean  @default(true) @map("is_active")
  lastTestedAt  DateTime? @map("last_tested_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  runs Run[]

  @@map("api_keys")
}

// Test definitions
model Test {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  name          String
  description   String?
  basePrompt    String   @map("base_prompt") // The prompt template
  variables     String   @default("{}") // JSON object for template variables
  modelConfigs  String   @default("[]") @map("model_configs") // JSON array of {provider, model} to test against
  
  // Validation rules (optional)
  expectedContains String? @map("expected_contains") // String that output should contain
  jsonSchema       String? @map("json_schema") // JSON schema for structured output validation
  
  // Tool settings (for future use)
  toolSettings  String?  @map("tool_settings") // JSON for tool configurations
  
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  runs Run[]

  @@map("tests")
}

// Run records - each execution of a test
model Run {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  testId          String?  @map("test_id") // Nullable for ad-hoc runs
  apiKeyId        String?  @map("api_key_id")
  
  // Provider/Model info
  provider        String
  model           String
  
  // Request info
  prompt          String   // The actual prompt sent (after variable substitution)
  inputVariables  String   @default("{}") @map("input_variables") // JSON of variables used
  
  // Response info
  output          String?  // The model's response
  status          String   @default("pending") // pending, running, completed, failed, dry_run
  errorMessage    String?  @map("error_message")
  
  // Metrics
  latencyMs       Int?     @map("latency_ms") // Response time in milliseconds
  inputTokens     Int?     @map("input_tokens")
  outputTokens    Int?     @map("output_tokens")
  totalTokens     Int?     @map("total_tokens")
  tokensEstimated Boolean  @default(false) @map("tokens_estimated") // True if tokens were estimated, not from provider
  
  // Cost
  estimatedCost   Float?   @map("estimated_cost") // In USD
  costEstimated   Boolean  @default(true) @map("cost_estimated") // True if cost was estimated
  
  // Validation results
  passed          Boolean? // null if no validation rules, true/false otherwise
  validationNotes String?  @map("validation_notes") // Details about pass/fail
  
  // Batch info
  batchId         String?  @map("batch_id") // Groups runs from same batch execution
  batchIndex      Int?     @map("batch_index") // Position in batch
  
  isDryRun        Boolean  @default(false) @map("is_dry_run")
  
  createdAt       DateTime @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at")

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  test   Test?   @relation(fields: [testId], references: [id], onDelete: SetNull)
  apiKey ApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([testId, createdAt])
  @@index([batchId])
  @@map("runs")
}

// Rate limiting tracking
model RateLimit {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  windowKey String   @map("window_key") // e.g., "2024-01-15T10:30" (minute window)
  count     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, windowKey])
  @@map("rate_limits")
}
